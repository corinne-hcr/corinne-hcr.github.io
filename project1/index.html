<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CS180 Project 1 — Colorizing the Prokudin—Gorskii Photo Collection</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
:root{
  --bg:#0a0d14; --fg:#e6e7ea; --muted:#a9b1bc; --card:#151a22;
  --accent:#6aa3ff; --green:#27ae60; --orange:#f39c12; --red:#e74c3c;
  --purple:#9b59b6; --cyan:#1abc9c;
  --shadow: 0 8px 32px rgba(0,0,0,0.3);
  --gradient: linear-gradient(135deg, rgba(106,163,255,0.1) 0%, rgba(155,89,182,0.1) 100%);
}

html,body{
  background: var(--bg);
  color: var(--fg);
  font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
  scroll-behavior: smooth;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: radial-gradient(circle at 20% 80%, rgba(106,163,255,0.03) 0%, transparent 50%),
              radial-gradient(circle at 80% 20%, rgba(155,89,182,0.03) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

main{
  max-width: 1400px;
  margin: 40px auto;
  padding: 0 24px;
}

/* Header improvements */
header {
  text-align: center;
  margin-bottom: 3rem;
  padding: 2rem 0;
}

h1,h2,h3{
  line-height: 1.25;
  margin: 1.5em 0 .8em;
  font-weight: 600;
}
h1{
  font-size: 2.5rem;
  background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 0.5rem;
}
h2{
  font-size: 1.8rem;
  color: #cfd6df;
  position: relative;
}
h2::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 60px;
  height: 3px;
  background: var(--accent);
  border-radius: 2px;
}
h3{font-size: 1.4rem; color: var(--accent);}

p,li{color: var(--fg)}

/* Card improvements */
.card{
  background: var(--card);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 2rem;
  border-radius: 16px;
  margin: 2rem 0;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
}

/* Grid improvements */
.grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 2rem;
  margin: 2rem 0;
}

@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* Legend improvements */
.legend{
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin: 1rem 0;
  padding: 1rem;
  background: rgba(255,255,255,0.02);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.05);
}

.badge{
  display: inline-flex;
  align-items: center;
  gap: .6rem;
  padding: .5rem 1rem;
  border-radius: 25px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: #cfd6df;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.badge:hover {
  background: rgba(255,255,255,0.1);
  transform: translateY(-1px);
}

.badge i{
  display: inline-block;
  width: 14px;
  height: 14px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.i-blue{background: var(--accent)} .i-green{background: var(--green)}
.i-orange{background: var(--orange)} .i-red{background: var(--red)}
.i-purple{background: var(--purple)} .i-cyan{background: var(--cyan)}

/* Slot wrapper for external titles */
.slot-wrapper {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.slot-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--fg);
  text-align: center;
  margin: 0;
  padding: 0.5rem;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.08);
}

/* Slot improvements - now perfectly aligned */
.slot{
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 320px;
  border-radius: 14px;
  background: rgba(255,255,255,0.02);
  text-align: center;
  padding: 1rem;
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
}

.slot::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--gradient);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.slot:hover::before {
  opacity: 1;
}

.slot:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.slot b{
  display: none; /* Hide internal titles since we use external ones */
}

.slot.small{min-height: 280px}

.slot-blue{border: 2.5px solid var(--accent); color: #cfe1ff}
.slot-green{border: 2.5px solid var(--green); color: #daf5e6}
.slot-orange{border: 2.5px solid var(--orange); color: #ffe6bf}
.slot-red{border: 2.5px solid var(--red); color: #ffd5d0}
.slot-purple{border: 2.5px solid var(--purple); color: #e9d7f8}
.slot-cyan{border: 2.5px solid var(--cyan); color: #c3fff4}

/* Image improvements */
:root {
  --img-w: 100%;
  --img-h: auto;
  --img-max-w: 420px;
  --img-max-h: 380px;
}

.slot img {
  width: var(--img-w);
  height: var(--img-h);
  max-width: var(--img-max-w);
  max-height: var(--img-max-h);
  object-fit: contain;
  object-position: center;
  display: block;
  margin: 0 auto;
  background: #0b0f16;
  border-radius: 8px;
  transition: all 0.3s ease;
  position: relative;
  z-index: 1;
}

.slot:hover img {
  transform: scale(1.02);
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}

/* Table improvements */
.table{
  width: 100%;
  border-collapse: collapse;
  background: var(--card);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.table th,.table td{
  border-bottom: 1px solid rgba(255,255,255,0.05);
  padding: 1rem 1.2rem;
  text-align: left;
}

.table tr:last-child td{border-bottom: none}
.table th{
  background: rgba(255,255,255,0.03);
  color: #cfd6df;
  font-weight: 600;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table tr:hover {
  background: rgba(255,255,255,0.02);
}

/* Code blocks */
pre{
  background: #0e131b;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 1.5rem;
  border-radius: 12px;
  overflow: auto;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
}

code{
  background: rgba(255,255,255,0.05);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-size: 0.9rem;
}

/* Links */
a{
  color: var(--accent);
  text-decoration: none;
  transition: color 0.2s ease;
}
a:hover{
  color: #b8d4ff;
  text-decoration: underline;
}

/* Misc improvements */
small, .muted{color: var(--muted)}
.kicker{
  letter-spacing: .1em;
  text-transform: uppercase;
  color: var(--accent);
  font-weight: 700;
  font-size: 0.85rem;
}

hr{
  border: none;
  border-top: 1px solid rgba(255,255,255,0.1);
  margin: 3rem 0;
}

figcaption{
  color: var(--muted);
  font-size: .9rem;
  margin-top: 1rem;
  text-align: center;
  font-style: italic;
}

figure{margin: 2rem 0}

footer {
  text-align: center;
  padding: 2rem 0;
  border-top: 1px solid rgba(255,255,255,0.1);
  margin-top: 3rem;
}

/* Responsive improvements */
@media (max-width: 768px) {
  main { padding: 0 1rem; }
  .card { padding: 1.5rem; }
  h1 { font-size: 2rem; }
  .grid { grid-template-columns: 1fr; gap: 1rem; }
  .slot { min-height: 280px; padding: 1rem; }
  :root {
    --img-max-w: 100%;
    --img-max-h: 300px;
  }
}

/* Scroll animations */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.card {
  animation: fadeInUp 0.6s ease forwards;
}

.card:nth-child(even) {
  animation-delay: 0.1s;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<main>
  <header>
    <h1>Project 1 — Colorizing the Prokudin—Gorskii Photo Collection</h1>
    <p class="muted">CS180 • Fall 2025 • <em>Chunrui Huang</em></p>
  </header>

  <section class="card">
    <h2>Overview</h2>
    <p>I colorize Prokudin—Gorskii glass plate scans by splitting the stacked <strong>B | G | R</strong> channels,
       aligning them, and merging into an RGB image. Small JPGs are aligned with a single-scale exhaustive search.
       Large high-resolution TIFs are aligned with a <strong>multi-scale pyramid</strong> framework.
       I evaluate two similarity metrics suggested by the handout: <em>Euclidean distance (L2)</em> and
       <em>Normalized Cross-Correlation (NCC)</em>. The green channel is used as the anchor (align <strong>B → G</strong> and <strong>R → G</strong>).</p>
    <p>For display only, I also show an optional "simple white balance" (WB) that rescales each channel so their global
       means match. WB is not required and sometimes looks worse on sky-heavy scenes, so my main results use the raw aligned RGB.</p>
  </section>

  <section class="card">
    <h2>Method</h2>

    <!-- 1) Data split & casting -->
    <h3>Pipeline</h3>
    <ol>
      <li><strong>Split & cast</strong> — Read the stacked grayscale scan, split into <b>B | G | R</b> thirds, convert to float in [0,1]. Use <b>G</b> as the anchor (align <b>B→G</b> and <b>R→G</b>).</li>

      <li><strong>Border crop (for scoring only)</strong> — Remove scan frames and padding so borders don’t dominate the metric: JPG ≈ 8%, TIF ≈ 15%.</li>

      <li><strong>Similarity metrics (maximize)</strong> — At each candidate shift \((\Delta y,\Delta x)\) score the <em>overlapping region only</em>.<br>
        L2 score as negative MSE:
        \[
          s_{L2}(A,B) \;=\; -\,\frac{1}{N}\sum_{x,y}\big(a(x,y)-b(x,y)\big)^2
        \]
        Normalized cross-correlation:
        \[
          \mathrm{NCC}(A,B)=\frac{\sum_{x,y}A_{xy}B_{xy}}{\sqrt{\sum A_{xy}^2}\,\sqrt{\sum B_{xy}^2}}
        \]
        (Higher is better for both.)
      </li>

      <li><strong>Search strategy</strong> —<br>
        <b>Single-scale (JPGs):</b> exhaustive window \([-15,15]\) on \((\Delta y,\Delta x)\); pick the max-score shift.<br>
        <b>Coarse-to-fine pyramid (TIFs):</b> downsample by 2 until the min side ≈ 400 px; search a larger window at the coarsest level (base ≈ ±40), then upsample and refine with ±2 at each finer level while accumulating shifts.
      </li>

      <li><strong>White balance (display only)</strong> — Gray-world scaling to match per-channel means; not used for scoring.
        <pre><code>means = [mean(R), mean(G), mean(B)]
  target = (mean(R) + mean(G) + mean(B)) / 3
  scale_c = target / mean(c)   # apply per channel
  RGB_wb  = clip(RGB * scale, 0, 1)</code></pre>
        <p class="muted">This helps sometimes but may hurt scenes with strong color bias (e.g., vast blue sky).</p>
      </li>

      <li><strong>Output</strong> — Merge aligned R,G,B; report shifts (B→G, R→G); save comparisons (Original / NCC / L2 / NCC+WB).</li>
    </ol>

    <p class="muted">Using <em>mean</em> instead of sum normalizes for overlap size, so scores are comparable across shifts.</p>
  </section>

  <section class="card">
    <h2>Results</h2>

    <h3>Single-scale alignment (JPG)</h3>
    <figure>
      <div class="grid">
        <!-- cathedral.jpg row -->
        <div class="slot-wrapper">
          <div class="slot-title">cathedral.jpg</div>
          <div class="slot slot-blue">
            <img src="outputs/cathedral_original.jpg" alt="Cathedral — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/cathedral_single_ncc.jpg" alt="Cathedral — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/cathedral_single_l2.jpg" alt="Cathedral — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/cathedral_single_ncc_wb.jpg" alt="Cathedral — NCC + WB">
          </div>
        </div>

        <!-- monastery.jpg row -->
        <div class="slot-wrapper">
          <div class="slot-title">monastery.jpg</div>
          <div class="slot slot-blue">
            <img src="outputs/monastery_original.jpg" alt="Monastery — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/monastery_single_ncc.jpg" alt="Monastery — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/monastery_single_l2.jpg" alt="Monastery — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/monastery_single_ncc_wb.jpg" alt="Monastery — NCC + WB">
          </div>
        </div>

        <!-- tobolsk.jpg row -->
        <div class="slot-wrapper">
          <div class="slot-title">tobolsk.jpg</div>
          <div class="slot slot-blue">
            <img src="outputs/tobolsk_original.jpg" alt="Tobolsk — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/tobolsk_single_ncc.jpg" alt="Tobolsk — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/tobolsk_single_l2.jpg" alt="Tobolsk — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/tobolsk_single_ncc_wb.jpg" alt="Tobolsk — NCC + WB">
          </div>
        </div>
      </div>

      <figcaption>
        Each row shows <em>Original → NCC → L2 → NCC+WB</em>. Offsets are reported below.
      </figcaption>
    </figure>

    <h3>Multi-scale pyramid alignment (TIF)</h3>
    <figure>
      <div class="grid">
        <!-- church.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">church.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/church_original.jpg" alt="church — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/church_pyr_ncc.jpg" alt="church — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/church_pyr_l2.jpg" alt="church — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/church_pyr_ncc_wb.jpg" alt="church — NCC + WB">
          </div>
        </div>

        <!-- emir.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">emir.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/emir_original.jpg" alt="emir — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/emir_pyr_ncc.jpg" alt="emir — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/emir_pyr_l2.jpg" alt="emir — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/emir_pyr_ncc_wb.jpg" alt="emir — NCC + WB">
          </div>
        </div>

        <!-- harvesters.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">harvesters.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/harvesters_original.jpg" alt="harvesters — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/harvesters_pyr_ncc.jpg" alt="harvesters — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/harvesters_pyr_l2.jpg" alt="harvesters — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/harvesters_pyr_ncc_wb.jpg" alt="harvesters — NCC + WB">
          </div>
        </div>

        <!-- icon.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">icon.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/icon_original.jpg" alt="icon — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/icon_pyr_ncc.jpg" alt="icon — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/icon_pyr_l2.jpg" alt="icon — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/icon_pyr_ncc_wb.jpg" alt="icon — NCC + WB">
          </div>
        </div>

        <!-- Irrigation canal (aryk) in the Murgab Estate.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">Irrigation canal (aryk) in the Murgab Estate.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/Irrigation canal (aryk) in the Murgab Estate_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/Irrigation canal (aryk) in the Murgab Estate_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/Irrigation canal (aryk) in the Murgab Estate_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/Irrigation canal (aryk) in the Murgab Estate_pyr_ncc_wb.jpg">
          </div>
        </div>

        <!-- italil.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">italil.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/italil_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/italil_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/italil_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/italil_pyr_ncc_wb.jpg">
          </div>
        </div>

        <!-- melons.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">melons.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/melons_original.jpg" alt="melons — original">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/melons_pyr_ncc.jpg" alt="melons — aligned by NCC">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/melons_pyr_l2.jpg" alt="melons — aligned by L2">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/melons_pyr_ncc_wb.jpg" alt="melons — NCC + WB">
          </div>
        </div>

        <!-- lastochikino.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">lastochikino.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/lastochikino_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/lastochikino_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/lastochikino_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/lastochikino_pyr_ncc_wb.jpg">
          </div>
        </div>

        <!-- self_portrait.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">self_portrait.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/self_portrait_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/self_portrait_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/self_portrait_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/self_portrait_pyr_ncc_wb.jpg">
          </div>
        </div>

        <!-- three_generations.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">three_generations.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/three_generations_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/three_generations_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/three_generations_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/three_generations_pyr_ncc_wb.jpg">
          </div>
        </div>
        

        <!-- Na ostrovi︠e︡ Kapri.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">Na ostrovi︠e︡ Kapri.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/Na ostrovi︠e︡ Kapri_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/Na ostrovi︠e︡ Kapri_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/Na ostrovi︠e︡ Kapri_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/Na ostrovi︠e︡ Kapri_pyr_ncc_wb.jpg">
          </div>
        </div>

        <!-- lugano.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">lugano.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/lugano_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/lugano_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/lugano_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/lugano_pyr_ncc_wb.jpg">
          </div>
        </div>
        
        <!-- siren.tif -->
        <div class="slot-wrapper">
          <div class="slot-title">siren.tif</div>
          <div class="slot slot-blue">
            <img src="outputs/siren_original.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC Aligned</div>
          <div class="slot slot-green">
            <img src="outputs/siren_pyr_ncc.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">L2 Aligned</div>
          <div class="slot slot-orange">
            <img src="outputs/siren_pyr_l2.jpg">
          </div>
        </div>
        <div class="slot-wrapper">
          <div class="slot-title">NCC + WB</div>
          <div class="slot slot-red">
            <img src="outputs/siren_pyr_ncc_wb.jpg">
          </div>
        </div>
  
      <figcaption>High-res TIFs are aligned with a coarse-to-fine pyramid. Offsets are reported below.</figcaption>
    </figure>


    <h3>Offsets (B→G and R→G)</h3>
    <p>The sheet below shows the displacements (dy, dx) found by the best-scoring shifts. I fill in after running the notebook.</p>
    <table class="table">
      <thead><tr><th>Image</th><th>Method</th><th>B → G (dy, dx)</th><th>R → G (dy, dx)</th></tr></thead>
      <tbody>
        <tr><td>cathedral.jpg</td><td>Single (NCC)</td><td>(-5, -2)</td><td>(7, 1)</td></tr>
        <tr><td>monastery.jpg</td><td>Single (NCC)</td><td>(3, -2)</td><td>(6, 1)</td></tr>
        <tr><td>tobolsk.jpg</td><td>Single (NCC)</td><td>(-3, -3)</td><td>(4, 1)</td></tr>
        <tr><td>Irrigation canal (aryk) in the Murgab Estate.tif</td><td>Pyramid (NCC)</td><td>(-41, -25)</td><td>(56, 18)</td></tr>
        <tr><td> Makhrovye maki.tif</td><td>Pyramid (NCC)</td><td>(-9, -8)</td><td>(52, 5)</td></tr>
        <tr><td> Na ostrovi︠e︡ Kapri.tif</td><td>Pyramid (NCC)</td><td>(-45, 13)</td><td>(58, 3)</td></tr>
        <tr><td>church.tif</td><td>Pyramid (NCC)</td><td>(-25, -4)</td><td>(33, -8)</td></tr>
        <tr><td>emir.tif</td><td>Pyramid (NCC)</td><td>(-48, -24)</td><td>(57, 17)</td></tr>
        <tr><td>harvesters.tif</td><td>Pyramid (NCC)</td><td>(-59, -17)</td><td>(65, -3)</td></tr>
        <tr><td>icon.tif</td><td>Pyramid (NCC)</td><td>(-41, -17)</td><td>(49, 5)</td></tr>
        <tr><td>italil.tif</td><td>Pyramid (NCC)</td><td>(-38, -21)</td><td>(39, 15)</td></tr>
        <tr><td>lastochikino.tif</td><td>Pyramid (NCC)</td><td>(3, 2)</td><td>(78, -7)</td></tr>
        <tr><td>lugano.tif</td><td>Pyramid (NCC)</td><td>(-41, 16)</td><td>(52, -13)</td></tr>
        <tr><td>melons.tif</td><td>Pyramid (NCC)</td><td>(-82, -10)</td><td>(96, 3)</td></tr>
        <tr><td>self_portrait.tif</td><td>Pyramid (NCC)</td><td>(-78, -29)</td><td>(98, 8)</td></tr>
        <tr><td>siren.tif</td><td>Pyramid (NCC)</td><td>(-49, 5)</td><td>(47, -19)</td></tr>
        <tr><td>three_generations.tif</td><td>Pyramid (NCC)</td><td>(-52, -14)</td><td>(59, -3)</td></tr>
      </tbody>
    </table>

    
  </section>
  
  <section class="card">
    <h2>Failure cases &amp; fixes</h2>
    <p>
      During development I ran into two major issues that caused alignment failures:
    </p>

    <ol>
      <li>
        <strong>L2 sum failure.</strong><br>
        When I used plain L2 <em>sum of squared differences</em> as the score, it favored shifts with a smaller overlapping region.
        This meant the best shift often snapped to the image borders instead of aligning actual structure.
        Cropping the borders and switching to <em>negative mean squared error (MSE)</em> fixed this bias.
        <br><em>Example:</em><br>
        <img src="L2sum_ Failure_church_pyr_l2.jpg" alt="L2 Sum Failure" style="max-width:420px; border-radius:8px; margin-top:0.5rem;">
      </li>

      <li>
        <strong>Single-scale failure on high-res TIFs.</strong><br>
        For large TIF images, a single-scale ±15 search window was far too narrow.
        True displacements were often 50–100 px, so the algorithm missed the correct match and locked onto strong scan borders.
        Brightness differences across channels made L2 even more sensitive.
        Images like <em>emir</em>, <em>melons</em>, and <em>self_portrait</em> were especially problematic.
        <br><em>Example:</em><br>
        <img src="TIF_ Failure_emir_aligned.jpg" alt="Single-scale TIF Failure" style="max-width:420px; border-radius:8px; margin-top:0.5rem;">
      </li>
    </ol>

    <p>
      <strong>How I solved it:</strong> I anchored alignment on the <b>green channel</b> (B→G and R→G), cropped borders (8% JPG, 15% TIF),
      and replaced L2 sum with <em>negative MSE</em> so that scores are comparable across different overlap sizes.
      For TIFs I adopted a <em>coarse-to-fine pyramid search</em>: downsampled by 2 until the min side ≈ 400 px, searched with a larger base window (≈ ±40),
      then refined with ±2 at finer scales while accumulating shifts. With these changes, both NCC and L2 produced consistent, high-quality alignments.
    </p>
  </section>


  <footer class="muted" style="margin:18px 0 40px">© 2025 — Chunrui Huang</footer>
</main>
</body>
</html>
